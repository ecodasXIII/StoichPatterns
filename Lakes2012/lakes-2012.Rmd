---
title: "Lakes 2012 nars data"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
if(!require("pacman")) install.packages("pacman")
library(pacman)
package.list = c("FedData","raster","sf","leaflet",
                 "readr","tidyverse","tictoc","fs",
                 "furrr")
pacman::p_load(char = package.list, install = T)
pacman::p_load_gh('jimjunker1/junkR')
rm('package.list')
theme_mod = theme_bw() %+replace% theme(panel.grid = element_blank())

knitr::opts_chunk$set(echo = TRUE)
# knitr::opts_knit
theme_set(theme_bw())

# nars_data = read_csv("./data/nars_data_table.csv")
nars_data = read_csv("../data/nars_data_table.csv");
nars_data$filename <- basename(nars_data$data_link)
```

Water chemistry data (DOC, TN, and TP): 2 files for chemistry --> site data and actual chemistry data

`lakes2012_wc1 <- nars_data %>% `
`  filter(Survey == "Lakes 2012",`
`         Indicator == "Water Chemistry") %>%`
`  pull(filename) %>% '[[' (1) %>% # metadata `
`  paste0("../raw-data/", .) %>%`
`  read_csv()`
  
`lakes2012_wc2 <- nars_data %>% `
`filter(Survey == "Lakes 2012",`
`       Indicator == "Water Chemistry") %>%`
`pull(filename) %>% '[[' (2) %>% # chemistry data `
`paste0("../raw-data/", .) %>%`
`read_csv()`

```{r, echo = FALSE, include=FALSE}
lakes2012_wc1 <- nars_data %>% 
  filter(Survey == "Lakes 2012",
         Indicator == "Water Chemistry") %>%
  pull(filename) %>% '[[' (1) %>% # metadata 
  paste0("../raw-data/", .) %>%
  read_csv()
lakes2012_wc2 <- nars_data %>% 
  filter(Survey == "Lakes 2012",
         Indicator == "Water Chemistry") %>%
  pull(filename) %>% '[[' (2) %>% # chemistry data 
  paste0("../raw-data/", .) %>%
  read_csv()
```

lakes2012_wc1 = H<sub>2</sub>O chem metadata  
lakes2012_wc2 = H<sub>2</sub>O chem data

```{r, echo = F, include = FALSE}
names(lakes2012_wc2)
```

Grab the follow variables:

-UID -> unique ID  
-SITE_ID -> site ID  
-DATE_COL -> date collected  
-DOC_RESULT -> DOC measurement mg/L  
-DOC_QA_FLAG -> DOC QA/QC flag  
-NTL_RESULT -> total N result mg/L  
-NTL_QA_FLAG -> total N QA/QC flag  
-PTL_RESULT -> total P result mg/L  
-PTL_QA_FLAG -> total P QA/QC flag 
-AGGR_ECO3_2015 -> EcoRegion variable

*Other variables of interest may be:
-

```{r variable select}
lakevars <- c("UID", "SITE_ID", "DATE_COL", "DOC_RESULT", "DOC_QA_FLAG", "NTL_RESULT", "NTL_QA_FLAG", "PTL_RESULT", "PTL_QA_FLAG", "AGGR_ECO3_2015")
```

Create new CNP data frame: lakes2012_CNP

```{r, echo = TRUE, warning=FALSE, message=FALSE}
lakes2012_meta <- dplyr::select(lakes2012_wc1, one_of(lakevars)) %>%
  unique()
lakes2012_data <- dplyr::select(lakes2012_wc2, one_of(lakevars))

lakes2012_CNP <- dplyr::inner_join(lakes2012_data, lakes2012_meta) %>%
  mutate(PTL_RESULT = PTL_RESULT/1000, #convert to mg/L
         C_mol = DOC_RESULT/12.011,
         N_mol = NTL_RESULT/14.007,
         P_mol = PTL_RESULT/30.974,
         CN_mol = (DOC_RESULT/NTL_RESULT)*(14.007/12.011),
         CP_mol = (DOC_RESULT/PTL_RESULT)*(30.974/12.011),
         NP_mol = (NTL_RESULT/PTL_RESULT)*(30.974/14.007))

```

Land cover data

```{r, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE}

#read in the lists of land use
land_use_temp = list.files(path = "../Lakes2012/", pattern = "*landuse_list.rds", full.names = TRUE)
land_use_files = lapply(land_use_temp, readRDS)#make list of landuse lists

land_use_dfs_list = map(land_use_files, function(x){
  x_names = names(x)
  x_df_list = map(x, ~..1 %>% spread(key = class_name, value = percent_cover))
  x_dfs = bind_rows(x_df_list)
  x_df_full = data.frame(SITE_ID = x_names, x_dfs, check.names = FALSE)
  colnames(x_df_full) = gsub(" ","_",colnames(x_df_full))
  return(x_df_full)
})

land_use_df = land_use_dfs_list %>%
  bind_rows() 

land_use_df = land_use_df %>%
  gather(key = class_name, value = percent_cover, -`SITE_ID`)

land_use_df_wide = land_use_df %>%
  group_by(SITE_ID) %>% summarise(total_use = sum(percent_cover, na.rm = TRUE))

#rename cover classes to aggregrated categories
#old names
old_cover_classes = list(c('Pasture/Hay','Cultivated_Crops'),
                         c('Developed_High_Intensity','Developed,_Low_Intensity',
                           'Developed,_Medium_Intensity','Developed,_Open_Space'),
                         c('Deciduous_Forest','Evergreen_Forest','Mixed_Forest'),
                         c('Open_Water','Woody_Wetlands','Emergent_Herbaceous_Wetlands'),
                         'Barren_Land_(Rock/Sand/Clay)',
                         'Grassland/Herbaceous',
                         'Shrub/Scrub',
                         'Perennial_Ice/Snow',
                         '<NA>')
# # #aggregated names
aggregate_cover_class = list('Agriculture',
                             'Developed',
                             'Forested',
                             'WetlandWater',
                             'Barren',
                             'Grassland',
                             'Shrubscrub',
                             'Ice_Snow',
                             "Unknown")
# 
# # #keyval list of changes
keyval = setNames(rep(aggregate_cover_class, lengths(old_cover_classes)), unlist(old_cover_classes))
#
# # #make changes to class names
land_use_df = land_use_df %>%
              mutate(class_name = recode(class_name, !!!keyval)) %>%
              group_by(SITE_ID, class_name) %>%
              summarise(percent_cover = sum(percent_cover)) %>% ungroup()
# #
lakes2012_full = inner_join(lakes2012_CNP, land_use_df %>% spread(key = class_name, value = percent_cover)) %>%
  mutate_at(vars(Agriculture:WetlandWater), replace_na, 0)
```

Response variables

```{r exploratory_plots, echo = FALSE, include = FALSE, warning=FALSE}

log_breaks = c(log10(0.001), log10(0.005), log10(0.01), log10(0.05), log10(0.1), log10(0.5), log10(1), log10(5), log10(10), log10(50), log10(100), log10(500), log10(1000),log10(5000), log10(10000), log10(50000),log10(100000))

raw_breaks = round(10^(log_breaks),3)

DOC_plot = ggplot(lakes2012_CNP, aes(x = log10(DOC_RESULT))) + geom_histogram() + 
  ggtitle("DOC distribution") + 
  scale_x_continuous(name = "DOC (mg/L)", breaks = log_breaks, labels = raw_breaks, limits = c(log10(0.06), log10(900))) + 
  theme(panel.grid = element_blank(), axis.title.y = element_blank(), 
        axis.text.x = element_text(angle = 45, hjust = 1,margin = margin(t = 3))) 

DOC_ecdf = ggplot(lakes2012_CNP, aes(x = log10(DOC_RESULT))) + stat_ecdf() + 
  ggtitle("DOC distribution") + 
  scale_x_continuous(name = "DOC (mg/L)", breaks = log_breaks, labels = raw_breaks, limits = c(log10(0.06), log10(900))) +theme(panel.grid = element_blank(), axis.title.y = element_blank(), 
        axis.text.x = element_text(angle = 45, hjust = 1,margin = margin(t = 3)))

TN_plot = ggplot(lakes2012_CNP, aes(x = log10(NTL_RESULT))) + geom_histogram() +
  ggtitle("TN distribtuion") + 
  scale_x_continuous(name = "TN (mg/L)", breaks = log_breaks, labels = raw_breaks, limits = c(log10(0.006), log10(90))) +
  theme(panel.grid = element_blank(), axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1, margin = margin(t = 3)))
TN_ecdf = ggplot(lakes2012_CNP, aes(x = log10(NTL_RESULT))) + stat_ecdf() +
  ggtitle("TN distribtuion") + 
  scale_x_continuous(name = "TN (mg/L)", breaks = log_breaks, labels = raw_breaks, limits = c(log10(0.006), log10(90))) +
  theme(panel.grid = element_blank(), axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1, margin = margin(t = 3)))

TP_plot = ggplot(lakes2012_CNP, aes(x = log10(PTL_RESULT))) + geom_histogram() +
  ggtitle("TP distribtion") + 
  scale_x_continuous(name = "TP (mg/L)", breaks = log_breaks, labels = raw_breaks,
                     limits = c(log10(0.0006), log10(9)))+
  theme(panel.grid = element_blank(), axis.title.y = element_blank(), 
        axis.text.x = element_text(angle = 45, hjust = 1,margin = margin(t = 3)))
TP_ecdf = ggplot(lakes2012_CNP, aes(x = log10(PTL_RESULT))) + stat_ecdf() +
  ggtitle("TP distribtion") + 
  scale_x_continuous(name = "TP (mg/L)", breaks = log_breaks, labels = raw_breaks,
                     limits = c(log10(0.0006), log10(9)))+
  theme(panel.grid = element_blank(), axis.title.y = element_blank(), 
        axis.text.x = element_text(angle = 45, hjust = 1,margin = margin(t = 3)))

CN_plot = ggplot(lakes2012_CNP, aes(x = CN_mol)) + geom_histogram() +
  ggtitle("C:N ratio distribution") +
  scale_x_continuous(name = "C:N (molar)") +
  theme(panel.grid = element_blank(), axis.title.y = element_blank(), 
        axis.text.x = element_text(angle = 45, hjust = 1,margin = margin(t = 3)))

CP_plot = ggplot(lakes2012_CNP, aes(x = CP_mol)) + geom_histogram() +
  ggtitle("C:P ratio distribution") +
  scale_x_continuous(name = "C:P (molar)") +
  theme(panel.grid = element_blank(), axis.title.y = element_blank(),
        axis.text = element_text(angle = 45, hjust = 1, margin = margin(t = 3)))

NP_plot = ggplot(lakes2012_CNP, aes(x = NP_mol)) + geom_histogram() +
  ggtitle("N:P ratio distribution") +
  scale_x_continuous(name = "N:P (molar)", limits = c(0,900)) +
  theme(panel.grid = element_blank(), axis.title.y = element_blank(),
        axis.text = element_text(angle = 45, hjust = 1, margin = margin(t = 3)))

```

Summary plots of elemental concentration and stoichiometry 

# DOC, TN, TP

```{r show_elem, echo = FALSE, fig.height = 3, fig.width = 9, message = FALSE, warning=FALSE}
gridExtra::grid.arrange(DOC_plot,TN_plot,TP_plot, ncol = 3)
```

# CN, CP, NP

```{r show_stoic, echo = FALSE, fig.height=3, fig.width=9, message = FALSE, warning = FALSE}
gridExtra::grid.arrange(CN_plot, CP_plot, NP_plot, ncol = 3)
```

What is the distribution of collection dates?

```{r, include = TRUE, echo = F, message = FALSE, warning=FALSE}
lakes2012_CNP <- lakes2012_CNP %>%
  mutate(date_formatted = as.Date(DATE_COL, format = "%d-%b-%y"),
         doy = lubridate::yday(date_formatted))

doy_breaks = c(0,32,60,91,121,152,182,213,244,274,305,335)
month_labels = c("jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec")

ggplot(lakes2012_CNP, aes(x = doy)) + geom_histogram() +
scale_x_continuous(name = "Day of Year", limits = c(0,366), breaks = doy_breaks,
                   labels = month_labels) +
  theme(axis.title.y = element_blank(), panel.grid = element_blank())
```

Lake Area distribution

```{r, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
Area_plot = ggplot(lakes2012_full, aes(x = log10(AREA_HA))) + geom_histogram() +
  scale_x_continuous(name = "Lake Area (Hectares)", breaks = log_breaks, labels = raw_breaks)+
  theme(panel.grid = element_blank(), axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1,margin = margin(t = 3)))
```

Bivariate elemental plots with stoichiometric isolines

```{r, include = TRUE, echo = FALSE, message = FALSE}
lines = c(rep(c('solid','dotted','dotted','dotted','dashed', 'dotted','dotted','dotted','dotted'),3),
          'solid','dotted','dotted','dotted','dashed','solid','dotted','dotted','dotted','dashed')
p1 = ggplot() +
  geom_line(data = NP, aes(x = Ppool, y = Npool, group = Stoic, linetype = Stoic), alpha = 0.7, size = 0.5, colour = "black") +
  scale_linetype_manual(values = lines) + theme_bw()+
  theme(panel.grid = element_blank(), legend.position = "none", axis.text = element_text(size = 20))#;p1

p1a = p1 + geom_point(data = lakes2012_full, aes(x = P_mol*1000, y = N_mol*1000), fill = 'red',  shape = 21, colour = "black", size = 2) + 
  xlab(expression("Phosphorus ("~mu*"mol)")) +
  ylab(expression("Nitrogen ("~mu*"mol)"))

p2 = p1a +   
   coord_cartesian(ylim = c(0.8,max(lakes2012_full$N_mol*1000)+1), 
                   xlim = c(0.08, max(lakes2012_full$P_mol*1000)+0.1)) +
  scale_y_log10() + scale_x_log10()

diss_NP.lm = lm(log10(N_mol*1000)~log10(P_mol*1000), data = lakes2012_full)
summary(diss_NP.lm)#;exp(diss_NP.lm$coefficients["(Intercept)"])

p3 = p2 + geom_text(aes(x = 0.09, y = 9.5, label = "100", size = 30), colour = "grey50", fontface = "bold", hjust = 1) +
  geom_text(aes(x = 0.09, y = 4.75, label = "50", size = 30), colour = "grey50", fontface = "bold", hjust = 1) +
  geom_text(aes(x = 0.09, y = 0.95, label = "10", size = 30), colour = "grey50", fontface = "bold", hjust = 1) +
  geom_text(aes(x = 0.09, y = 47.5, label = "500", size = 30), colour = "grey50", fontface = "bold", hjust = 1) +
  geom_text(aes(x = 0.09, y = 95, label = "1000", size = 30), colour = "grey50", fontface = "bold", hjust = 1) +
  geom_text(aes(x = 0.09, y = 450, label = "5000", size = 30), colour = "grey50", fontface = "bold",hjust = 1) +
  geom_text(aes(x = 120, y = 11, label = "0.1", size = 30), colour = "grey50", fontface = "bold",hjust = 0) +
  geom_text(aes(x = 120, y = 60, label = "0.5", size = 30), colour = "grey50", fontface = "bold",hjust = 0) +
  geom_text(aes(x = 120, y = 120, size = 30, label = "1"), colour = "grey50", fontface = "bold",hjust = 0) +
  geom_text(aes(x = 120, y = 600, label = "5", size = 30), colour = "grey50", fontface = "bold",hjust = 0) +
  geom_text(aes(x = 120, y = 1200, label = "10", size = 30), colour = "grey50", fontface = "bold",hjust = 0) +
  # geom_text(aes(x = 0.88, y = 10, label = "10", size = 30), colour = "grey50", fontface = "bold") +
  # geom_text(aes(x = 0.88, y = 50, label = "50", size = 30), colour = "grey50", fontface = "bold") +
  # geom_text(aes(x = 0.88, y = 100, label = "100", size = 30), colour = "grey50", fontface = "bold") +
  annotate("text",x = 0.09, y = 3000, label = paste("N:P scaling\nexponent =",round(diss_NP.lm$coefficients[2],2),
                                                   " ± ",round(summary(diss_NP.lm)$coefficients[4],2),sep=""), size = 4, hjust = 0);p3
########## 
```

```{r, include = TRUE}
